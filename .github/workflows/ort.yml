name: Simple ORT Complete Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ORT_RESULTS_DIR: ort-results
  ORT_DATA_DIR: ort-data

jobs:
  ort-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ§¹ Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h

    - name: ğŸ“ Setup Directories
      run: |
        mkdir -p ${{ env.ORT_RESULTS_DIR }}
        mkdir -p ${{ env.ORT_DATA_DIR }}
        echo "Created directories:"
        ls -la

    - name: ğŸ’¾ Cache ORT Data
      uses: actions/cache@v4
      with:
        path: ${{ env.ORT_DATA_DIR }}
        key: ort-cache-${{ hashFiles('**/requirements.txt', '**/package*.json', '**/pom.xml', '**/build.gradle*', '**/Cargo.toml', '**/go.mod', '**/pubspec.yaml') }}
        restore-keys: |
          ort-cache-

    - name: ğŸ³ Pull ORT Docker Image
      run: |
        echo "Pulling ORT Docker image..."
        docker pull ghcr.io/oss-review-toolkit/ort:latest --platform linux/x86_64
        echo "âœ… ORT image ready"

    - name: ğŸ” ORT Analyze (Find Dependencies)
      run: |
        echo "ğŸ” Starting dependency analysis..."
        docker run --rm --platform linux/x86_64 \
          -v ${{ github.workspace }}:/project \
          -v ${{ github.workspace }}/${{ env.ORT_DATA_DIR }}:/tmp/ort-data \
          -w /project \
          ghcr.io/oss-review-toolkit/ort:latest \
          analyze \
          -i /project \
          -o /project/${{ env.ORT_RESULTS_DIR }} \
          -f JSON,YAML \
          --data-dir /tmp/ort-data
        echo "âœ… Analysis complete"

    - name: ğŸ“¥ ORT Download (Get Source Code)
      run: |
        echo "ğŸ“¥ Downloading source code for dependencies..."
        docker run --rm --platform linux/x86_64 \
          -v ${{ github.workspace }}:/project \
          -v ${{ github.workspace }}/${{ env.ORT_DATA_DIR }}:/tmp/ort-data \
          -w /project \
          ghcr.io/oss-review-toolkit/ort:latest \
          download \
          -i /project/${{ env.ORT_RESULTS_DIR }}/analyzer-result.yml \
          -o /project/${{ env.ORT_RESULTS_DIR }} \
          --data-dir /tmp/ort-data
        echo "âœ… Download complete"

    - name: ğŸ” ORT Scan (Find Licenses)
      run: |
        echo "ğŸ” Scanning for licenses and copyrights..."
        docker run --rm --platform linux/x86_64 \
          -v ${{ github.workspace }}:/project \
          -v ${{ github.workspace }}/${{ env.ORT_DATA_DIR }}:/tmp/ort-data \
          -w /project \
          ghcr.io/oss-review-toolkit/ort:latest \
          scan \
          -i /project/${{ env.ORT_RESULTS_DIR }}/downloader-result.yml \
          -o /project/${{ env.ORT_RESULTS_DIR }} \
          --data-dir /tmp/ort-data
        echo "âœ… Scan complete"

    - name: ğŸ›¡ï¸ ORT Advise (Security Check)
      run: |
        echo "ğŸ›¡ï¸ Checking for security vulnerabilities..."
        docker run --rm --platform linux/x86_64 \
          -v ${{ github.workspace }}:/project \
          -v ${{ github.workspace }}/${{ env.ORT_DATA_DIR }}:/tmp/ort-data \
          -w /project \
          ghcr.io/oss-review-toolkit/ort:latest \
          advise \
          -i /project/${{ env.ORT_RESULTS_DIR }}/analyzer-result.yml \
          -o /project/${{ env.ORT_RESULTS_DIR }} \
          -a OSV \
          --data-dir /tmp/ort-data
        echo "âœ… Security check complete"

    - name: ğŸ“Š ORT Report (Generate Reports)
      run: |
        echo "ğŸ“Š Generating final reports..."
        
        # Find the most complete result file to use as input
        if [ -f "${{ env.ORT_RESULTS_DIR }}/scan-result.yml" ]; then
          INPUT_FILE="/project/${{ env.ORT_RESULTS_DIR }}/scan-result.yml"
          echo "Using scan results as input"
        else
          INPUT_FILE="/project/${{ env.ORT_RESULTS_DIR }}/advisor-result.yml"
          echo "Using advisor results as input"
        fi
        
        docker run --rm --platform linux/x86_64 \
          -v ${{ github.workspace }}:/project \
          -w /project \
          ghcr.io/oss-review-toolkit/ort:latest \
          report \
          -i $INPUT_FILE \
          -o /project/${{ env.ORT_RESULTS_DIR }} \
          -f WebApp,StaticHtml,SpdxDocument,CycloneDx,PlainTextTemplate
        echo "âœ… Reports generated"

    - name: ğŸ“‹ Show Results Summary
      run: |
        echo "ğŸ“‹ Pipeline Results:"
        echo "==================="
        ls -la ${{ env.ORT_RESULTS_DIR }}/
        echo ""
        echo "ğŸ“Š Generated Reports:"
        echo "- Interactive HTML: ${{ env.ORT_RESULTS_DIR }}/StaticHtml/"
        echo "- SPDX SBOM: ${{ env.ORT_RESULTS_DIR }}/bom.spdx.yml"
        echo "- CycloneDX SBOM: ${{ env.ORT_RESULTS_DIR }}/bom.json"
        echo "- Plain Text Report: ${{ env.ORT_RESULTS_DIR }}/NOTICE"
        echo ""
        
        # Count dependencies if analyzer result exists
        if [ -f "${{ env.ORT_RESULTS_DIR }}/analyzer-result.yml" ]; then
          DEPS=$(grep -c "^    - " "${{ env.ORT_RESULTS_DIR }}/analyzer-result.yml" 2>/dev/null || echo "0")
          echo "ğŸ“¦ Total dependencies found: $DEPS"
        fi

    # Step 12: Create GitHub summary
    - name: ğŸ“ Create Job Summary
      if: always()
      run: |
        echo "# ğŸ¯ ORT Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Results Overview" >> $GITHUB_STEP_SUMMARY
        echo "| File | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| \`StaticHtml/scan-report-web-app.html\` | Interactive dashboard |" >> $GITHUB_STEP_SUMMARY
        echo "| \`bom.spdx.yml\` | SPDX Software Bill of Materials |" >> $GITHUB_STEP_SUMMARY
        echo "| \`bom.json\` | CycloneDX SBOM |" >> $GITHUB_STEP_SUMMARY
        echo "| \`NOTICE\` | License notices |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ‰ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the \`ort-results\` artifact below" >> $GITHUB_STEP_SUMMARY
        echo "2. Open \`StaticHtml/scan-report-web-app.html\` in your browser" >> $GITHUB_STEP_SUMMARY
        echo "3. Review license compliance and security findings" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“¤ Upload Complete Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-complete-results
        path: |
          ${{ env.ORT_RESULTS_DIR }}/
          !${{ env.ORT_DATA_DIR }}/
        retention-days: 30

    - name: ğŸ“¤ Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-html-report
        path: ${{ env.ORT_RESULTS_DIR }}/StaticHtml/
        retention-days: 90

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ğŸ¯ ORT Analysis Complete\n\n`;
          comment += `âœ… Full ORT pipeline executed successfully!\n\n`;
          comment += `### ğŸ“ Results Available:\n`;
          comment += `- **Interactive Report**: Download \`ort-html-report\` artifact\n`;
          comment += `- **Complete Analysis**: Download \`ort-complete-results\` artifact\n`;
          comment += `- **SPDX SBOM**: Software Bill of Materials generated\n`;
          comment += `- **Security Scan**: Vulnerability analysis included\n\n`;
          comment += `### ğŸ”— Quick Access:\n`;
          comment += `- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          comment += `- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n\n`;
          comment += `Open \`StaticHtml/scan-report-web-app.html\` from the HTML report artifact to view the interactive dashboard! ğŸš€`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });